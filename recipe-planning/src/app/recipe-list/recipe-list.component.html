<div class="container">
  <!-- SEARCH BAR -->

  <!-- Updated Search and Actions Container -->
  <div class="search-actions-container">
    <div class="search-box-container">
      <input
        type="text"
        placeholder="Search recipes..."
        [(ngModel)]="searchTerm"
        (input)="onSearch(searchTerm)"
        (focus)="isFocused = true"
        (blur)="onBlur()"
        class="search-box"
      />

      <!-- Search Results Dropdown -->
      <div
        *ngIf="(isFocused || searchTerm) && filteredRecipes.length > 0"
        class="search-result"
      >
        <div *ngFor="let recipe of filteredRecipes">
          <a
            [routerLink]="['/recipe', recipe.id]"
            (click)="clearSearch()"
            class="search-link"
          >
            <h3>{{ recipe.recipe_name }}</h3>
            <p>By {{ recipe.author }}</p>
          </a>
        </div>
      </div>
    </div>

    <div class="actions-container">
      <div class="post-recipe-button" *ngIf="currentUser">
        <a routerLink="/add-recipe" class="button is-primary">
          <strong>Post New Recipe</strong>
        </a>
      </div>

      <div class="filter-toggle">
        <button (click)="showFilters = !showFilters">
          {{ showFilters ? "Hide Filters" : "Filters" }}
        </button>
      </div>
    </div>
  </div>

  <div
    *ngIf="(isFocused || searchTerm) && filteredRecipes.length === 0"
    class="no-results"
  >
    <p>No recipes found matching "{{ searchTerm }}"</p>
  </div>

  <!-- FILTERS SECTION -->
  <div *ngIf="showFilters" class="filters-container">
    <div class="filter-group">
      <h4>Type:</h4>
      <button (click)="selectFilter('type', '')">All</button>
      <button (click)="selectFilter('type', 'breakfast')">Breakfast</button>
      <button (click)="selectFilter('type', 'lunch')">Lunch</button>
      <button (click)="selectFilter('type', 'dinner')">Dinner</button>
      <button (click)="selectFilter('type', 'snack')">Snack</button>
    </div>

    <div class="filter-group">
      <h4>Cuisine:</h4>
      <button (click)="selectFilter('cuisine', '')">All</button>
      <button (click)="selectFilter('cuisine', 'Italian')">Italian</button>
      <button (click)="selectFilter('cuisine', 'American')">American</button>
      <button (click)="selectFilter('cuisine', 'Indian')">Indian</button>
    </div>

    <div class="filter-group">
      <h4>Max Cooking Time:</h4>
      <button (click)="selectFilter('cookingTime', 0)">Any</button>
      <button (click)="selectFilter('cookingTime', 30)">≤ 30 min</button>
      <button (click)="selectFilter('cookingTime', 60)">≤ 60 min</button>
    </div>

    <div class="filter-group">
      <h4>Ingredient:</h4>
      <button (click)="selectFilter('ingredient', '')">Any</button>
      <button (click)="selectFilter('ingredient', 'egg')">Egg</button>
      <button (click)="selectFilter('ingredient', 'chicken')">Chicken</button>
      <button (click)="selectFilter('ingredient', 'rice')">Rice</button>
    </div>

    <div>
      <button (click)="clearFilters()">Clear All Filters</button>
    </div>
  </div>
</div>
<h2 class="recipe-list-title">All Recipes</h2>
<div class="recipe-list-container">
  <div
    class="recipe-card"
    *ngFor="let recipe of filteredRecipes"
    [routerLink]="['/recipe', recipe.id]"
  >
    <div class="recipe-image-container">
      <img
        [src]="recipe.imagePath"
        [alt]="recipe.recipe_name"
        class="recipe-image"
      />
      <span class="recipe-tag" *ngIf="recipe.type">{{ recipe.type }}</span>
    </div>
    <div class="recipe-card-content">
      <h3 class="recipe-title">{{ recipe.recipe_name }}</h3>
      <div class="recipe-meta">
        <div class="recipe-author" [routerLink]="['/user', recipe.authorId]">
          By {{ recipe.author }}
        </div>
        <span *ngIf="recipe.cooking_time"
          ><i class="material-icons">schedule</i>
          {{ recipe.cooking_time }}</span
        >
      </div>

      <div class="recipe-details">
        <p><strong>Author:</strong> {{ recipe.author }}</p>
        <p><strong>Meal Type:</strong> {{ recipe.meal }}</p>
        <p><strong>Ingredients:</strong> {{ recipe.ingredients.join(", ") }}</p>
        <p><strong>Instructions:</strong> {{ recipe.instructions }}</p>
        <p><strong>Nutrition:</strong> {{ recipe.nutrition_facts }}</p>
        <p><strong>Cuisine:</strong> {{ recipe.cuisine }}</p>
        <p><strong>Cooking Time:</strong> {{ recipe.cooking_time }} mins</p>

        <button (click)="saveRecipe(recipe)" class="save-button">
          Save Recipe
        </button>
      </div>

      <!-- REVIEWS SECTION -->
      <div class="reviews-section">
        <button (click)="toggleReviews(recipe.id)">
          {{ showReviews[recipe.id] ? "Hide Reviews" : "View Reviews" }}
        </button>

        <div
          *ngIf="
            showReviews[recipe.id] && (reviewsMap[recipe.id] | async) as reviews
          "
        >
          <h3>Reviews:</h3>
          <div *ngIf="reviews.length > 0; else noReviews">
            <div *ngFor="let review of reviews" class="review-item">
              <p>⭐ {{ review.rating }} / 5 by {{ review.userName }}</p>
              <p>{{ review.review }}</p>
            </div>
          </div>
          <ng-template #noReviews>
            <p>No reviews yet. Be the first!</p>
          </ng-template>
        </div>
      </div>

      <!-- ADD A REVIEW FORM -->
      <div class="add-review">
        <button (click)="toggleAddReview(recipe.id)">
          {{ showAddReview[recipe.id] ? "Cancel" : "Add Review" }}
        </button>

        <div *ngIf="showAddReview[recipe.id]">
          <form (ngSubmit)="submitReview(recipe.id)">
            <label for="rating">Rating (1-5):</label>
            <input
              type="number"
              id="rating"
              name="rating"
              [(ngModel)]="newRating[recipe.id]"
              min="1"
              max="5"
              required
            />

            <label for="review">Your Review:</label>
            <textarea
              id="review"
              name="review"
              [(ngModel)]="newReview[recipe.id]"
              required
            ></textarea>

            <div class="review-buttons">
              <button type="submit">Submit Review</button>
              <button type="button" (click)="toggleAddReview(recipe.id)">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
